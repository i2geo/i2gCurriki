## http://next.dev.curriki.org/xwiki/bin/edit/CreateResources/WebQuest
## by Niels P. Mayer ( http://nielsmayer.com )
## originally from http://next.dev.curriki.org/xwiki/bin/view/Groups/CreateNewGroup?viewer=code&showlinenumbers=0&language=en
## Attempting to emulate form in http://www.curriki.org/xwiki/bin/view/Project/Form+Templates?xpage=print&language=en
##
## ---------- PREAMBLE, CHECK AUTHORIZATION ----------
##
##UNCOMMENT-TO-USE-LOCAL-STYLESHEET
## <link rel="stylesheet" href="/xwiki/bin/view/CreateResources/styleCSLP?xpage=plain" type="text/css" />
##UNCOMMENT-TO-USE-LOCAL-STYLESHEET
##
####################################	If not login, show login information
#if( $context.user=="XWiki.XWikiGuest" )
  #set( $logredir = $xwiki.getRequestURL() )
  #set( $url = $xwiki.getURL("XWiki.XWikiLogin","login","xredirect=$logredir") )
  $msg.get("createresources.needaccount", [$url])
#else
####################################	If logined, show WebQuest page
  #includeMacros("CreateResources.StyledMacros")
  #set( $pageName   = $request.getParameter("pageName") )
  #set( $cameFrom   = $request.getParameter("cameFrom") )
  #set( $flow       = $request.getParameter("flow") )
  #set( $parentPage = $request.getParameter("parentPage") )
  #set( $publishSpace = $request.getParameter("publishSpace") )
    #set( $reqparas = $request.getParameterNames() )

  #if( "$!pageName" != "" ) 
	 #set( $newAsset  = $xwiki.curriki.fetchAsset($pageName) )
  #else
	 #set( $newAsset = $xwiki.curriki.createAsset($xwiki.null) )
  #end 

####################################	If newAsset is null, show error message
  #if( "$!newAsset"=="" ) 
	#if( "$!pageName" != "" )<p>asset creation error:</p>#else<p>asset lookup error:</p>#end
	<dl>
	  <dt>request.method</dt><dd>$!request.method</dd>
	  <dt>request.page</dt><dd>$!request.page</dd>
	  <dt>getParameter("pageName")</dt><dd>$!pageName</dd>
	  <dt>getParameter("cameFrom")</dt><dd>$!cameFrom</dd>
	  <dt>getParameter("flow")</dt><dd>$!flow</dd>
	  <dt>getParameter("parentPage")</dt><dd>$!parentPage</dd>
	  <dt>getParameter("publishSpace")</dt><dd>$!publishSpace</dd>
	</dl>
  #else
####################################	else ,show page
{pre}
<script language="javascript" type="text/javascript">

function checkWebQuestForm() {
  var missed_fields_str = '';
  if (getFieldContentStr('CurrikiCode.AssetClass_0_title') == null) {
	missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.title')');
  }
  if (getFieldContentStr('CurrikiCode.AssetClass_0_description') == null) {
	missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.description')');
  }
  /*{
	var form_fw_items = getFieldContentStr('CurrikiCode.AssetClass_0_fw_items');
	if ((form_fw_items == null) || (form_fw_items == 'FW_masterFramework.WebHome')) {
	  missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.subject')');
	}
  }
  { // Eductional-Level -- for validation, must look at "checked" on each button.
	var one_checked = false;
	for (var idx = 0, form_checkboxes = document.forms.inline['CurrikiCode.AssetClass_0_educational_level'];
	 ((idx < form_checkboxes.length) && !one_checked);
	 idx++) {
	  if (form_checkboxes[idx].checked) {
	one_checked = true;
	  }
	}
	if (!one_checked) {
	  missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.level')');
	} 
  }*/

  if (getWysiwygFieldContent('mce_editor_0', 'nlp_intro') == null) {
    missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('wq.required.fields.dialog.introduction')');
  }

  if (getWysiwygFieldContent('mce_editor_1', 'nlp_task') == null) {
    missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('wq.required.fields.dialog.task')');
  }

  if (getWysiwygFieldContent('mce_editor_2', 'nlp_process') == null) {
    missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('wq.required.fields.dialog.process')');
  }

  if(!chekcTableText()){
    missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('wq.required.fields.dialog.evaluation')');
  }

  if (getWysiwygFieldContent('mce_editor_3', 'nlp_conclusion') == null) {
    missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('wq.required.fields.dialog.conclusion')');
  }

  if (getFieldContentStr('CurrikiCode.AssetLicenseClass_0_rightsHolder') == null) {
    missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.rights')');
  }
  if (getAttachmentsSize() > $msg.get("wq.file.size.maximum")) {
	missed_fields_str = missed_fields_str + '\n\n' + '$msg.get('wq.file.size.oversize')';
  }
  var error_msg = "";
  if(missed_fields_str != ''){
	error_msg = '$msg.get('lesson.plan.required.fields.dialog')' + missed_fields_str;
  }else{
	if (getFieldContentStr('CurrikiCode.AssetClass_0_title').length > 250) {
	  error_msg = '$msg.get("wq.title.more.250")';
	}
  }

  if (error_msg != '') { // since theres error messages, validation failed... bail out.
	alert(error_msg);
	setTextAssetToWikiText('$msg.get('form.done.wysiwyg.error.wikitext')');  // not POSTing due to 'false' return below, so this should not matter -- reset in case of going "back" in browser after successful POST??
	setSuccessMessage('');     //not POSTing due to 'false' return below, so this should not matter -- reset in case of going "back" in browser after successful POST??
	return false;
  }
  else {
	setTextAssetToWikiText(formatTextareasIntoWikiText());
	setSuccessMessage('$msg.get('form.done.created.lessonplan')');
	return true;
  }
}

function checkWebQuestDirty() {
  if (getAttachmentsSize() > 0) {
	return true;
  }
  if (getFieldContentStr('CurrikiCode.AssetClass_0_title') != null) {
	return true;
  }
  if (getFieldContentStr('CurrikiCode.AssetClass_0_description') != null) {
	return true;
  }
  if (wysiwygIsDirty('mce_editor_0')) {
	return true;
  }
  if (wysiwygIsDirty('mce_editor_1')) {
	return true;
  }
  if (wysiwygIsDirty('mce_editor_2')) {
	return true;
  }
  if (wysiwygIsDirty('mce_editor_3')) {
	return true;
  }
  return false;
}

function wysiwygIsDirty(wysiwyg_id_str) {
    var wysiwyg_o = tinyMCE.getInstanceById(wysiwyg_id_str);
    return ((wysiwyg_o != null) && wysiwyg_o.isDirty());
}

function formatTextareasIntoWikiText() { 			
    var slp_str = '';		// the string we concat into the TextAssetClass contents
  var title_markup_str = '*';
  var vert_break_str = '\\\\\n\n'
  {
    var form_introduction = getWysiwygFieldContent('mce_editor_0', 'nlp_intro');
    if (form_introduction != null) {
      slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("wq.intro.title")' + title_markup_str +  vert_break_str + form_introduction;
    }
  } 

  {
    var form_task = getWysiwygFieldContent('mce_editor_1', 'nlp_task');
    if (form_task != null) {
      slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("wq.task.title")' + title_markup_str +  vert_break_str + form_task;
    }
  } 

  {
    var form_process = getWysiwygFieldContent('mce_editor_2', 'nlp_process');
    if (form_process != null) {
      slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("wq.process.title")' + title_markup_str +  vert_break_str + form_process;
    }
  } 

  {	//js table
	var form_table_text = getTableText();
	if (form_table_text != null) {
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("wq.eval.title")' + title_markup_str +  vert_break_str + form_table_text
	}
  } 

  {
    var form_conclusion = getWysiwygFieldContent('mce_editor_3', 'nlp_conclusion');
    if (form_conclusion != null) {
      slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("wq.conclusion.title")' + title_markup_str +  vert_break_str + form_conclusion;
    }
  } 

  {
    var form_cred = getWysiwygFieldContent('mce_editor_4', 'nlp_cred');
    if (form_cred != null) {
      slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("wq.cred.title")' + title_markup_str +  vert_break_str + form_cred;
    }
  }

  {
    var form_standards = getWysiwygFieldContent('mce_editor_5', 'nlp_standards');
    if (form_standards != null) {
      slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("wq.standards.title")' + title_markup_str +  vert_break_str + form_standards;
    }
  } 

  {
	var file_list = getAttachmentsNames();
	if (file_list.length > 0) {
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("wq.required.attachments.title")' + title_markup_str + vert_break_str + '#' + 'currikiattachmentBegin()\n';
	  for (var idx = 0; (idx < file_list.length); idx++) {
	// for macro currikiattachment($fname) see web/src/main/webapp/skins/curriki8/macros.vm
	slp_str = slp_str + '#' + 'currikiattachment("' + file_list[idx] + '")\n';
	  }
	  slp_str = slp_str + '#' + 'currikiattachmentEnd()\n' + vert_break_str;
	}
  }
  return (slp_str);
}

function setTextAssetToWikiText(str) {
  var input_field_TextAssetClass_o = $('CurrikiCode.TextAssetClass_0_text');
  if (input_field_TextAssetClass_o != null) {
	input_field_TextAssetClass_o.value = str;
  }
  else { alert('error in setTextAssetToWikiText()'); }
}

function getFieldContentStr(field_id_str) {
  var field_content_o   = $(field_id_str);
  var field_content_str = (field_content_o==null) ? "" : field_content_o.value;
  if ((field_content_str.length < 1) || (field_content_str.trim() == '')) {
	return (null);
  }
  else {
	return (field_content_str);
  }
}

// get wysiwyg contents... returns null if no content, else string of
// wikitext.  if wysiwyg_id_str WYSIWYG is not created due to platform or
// browser issues, fallback to using values in textarea assoc'd with
// wysiwyg (in which case plaintext, not wikitext).
function getWysiwygFieldContent(wysiwyg_id_str, textarea_fallback_id_str) {
  var wysiwyg_content_o = tinyMCE.getInstanceById(wysiwyg_id_str); // WYSIWYG Associated with "Content"
  if (wysiwyg_content_o == null) { // no WYSIWYG-->falback to textarea contents...
    var wysiwyg_content_txt  = $(textarea_fallback_id_str).value;
    if ((wysiwyg_content_txt.length <= 1) || (wysiwyg_content_txt.trim() == '')) {
      return null;	   // --> return signal for empty fallback textarea contents
    }
    else {
      return wysiwyg_content_txt; // return fallback textarea contents
    }
  }
  else if (!wysiwyg_content_o.isDirty()) { // WYSIWYG exists but empty...
    return null;		// --> return signal for empty contents
  }
  else {			// WYSIWYG exists with content...
    return (tinyMCE.getContent(wysiwyg_id_str));
  }
}

function setSuccessMessage(str) {
  var input_field_successMessage_o = $('successMessage');
  if (input_field_successMessage_o != null) {
	input_field_successMessage_o.value = str;
  }
  else { alert('error in setSuccessMessage()'); }
}

function appendSeparatedErrorMessageStr(message_str, missed_field_err_str) {
  return(message_str + '\n\t\t' + missed_field_err_str);
}

var needUnloadDialog = false;
function clearUnloadDialog() {
  needUnloadDialog = false;
}

function onWindowUnloading(e) {
  // if the form is not "dirty" don't pop form.leaving.dialog
  if (needUnloadDialog && checkWebQuestDirty()) {
	e.browserEvent.returnValue = "$msg.get('form.leaving.dialog')";
  }
}

function setUnloadDialog() {
  // window.onbeforeunload = unloadDialog;
  Ext.EventManager.on(window, 'beforeunload', onWindowUnloading); 
  needUnloadDialog = true;
}

function getAttachmentsSize() {
  return (window.frames['attachment_iframe'].getAttachmentsSize());
}

function getAttachmentsNames() {
  return (window.frames['attachment_iframe'].getAttachmentsNames());
}

function setAttachmentsIframeSize() {
  var iframe_o = document.getElementById('attachment_iframe');
  try {
	if (iframe_o != null) {
	  iframe_o.height = iframe_o.style.height = 50;  // attempt reset because FF behavior is grow-only
	}
	// this is portable way of getting at iframe DOM content per
	// http://www.mabaloo.com/Web-Development/Creating-controlling-and-manipulating-an-Iframe-through-JavaScript.html
	var doc_o = (iframe_o.contentWindow || iframe_o.contentDocument);  
	if (doc_o.document) {
	  doc_o = doc_o.document;
	}
	// the iframe needs more space than 'scrollHeight' says, or we get
	// scrollbars. 5 seems to accomodate the inner and outer margin, and
	// inner and outer border, with one pixel for the margin itself.
	// nb: iframe_o.style.height only works in IE, does nothing in FF.
	// do em both for good measure?!
	if (iframe_o != null) {
	   if (Ext.isIE6) {
	     iframe_o.height = iframe_o.style.height = doc_o.body.scrollHeight * 2 + 5;
	   } else {
	     iframe_o.height = iframe_o.style.height = doc_o.body.scrollHeight + 5;
	   }
	}
  }
  catch(e) {
	if (iframe_o != null) {
	  iframe_o.height = iframe_o.style.height = 300; // bigger default height value if things go wrong
	}
  } 
}
</script>

<style type="text/css">
body.p-CreateResources-WebQuest .x-grid3-header {background:#93c53c;}
body.p-CreateResources-WebQuest .x-grid3-header span img {margin: -4px 0 -4px 4px;}
body.p-CreateResources-WebQuest .x-grid3-scroller .x-grid3-row {border-color: #ccc; border-top:none;}
body.p-CreateResources-WebQuest .x-grid3-scroller {margin-bottom:5px;}
body.p-CreateResources-WebQuest input[type="button"] {font-weight:normal;}
.x-grid3-hd-0{text-align:center;}
.x-grid3-hd-1{text-align:center;}
.x-grid3-hd-2{text-align:center;}
.x-grid3-hd-3{text-align:center;}
.x-grid3-hd-4{text-align:center;}
.x-grid3-td-0{border-right: 1px solid lightgrey; padding-left: 0px !important;padding-right: 0px !important}
.x-grid3-td-1{border-right: 1px solid lightgrey; padding-left: 0px !important;padding-right: 0px !important}
.x-grid3-td-2{border-right: 1px solid lightgrey; padding-left: 0px !important;padding-right: 0px !important}
.x-grid3-td-3{border-right: 1px solid lightgrey; padding-left: 0px !important;padding-right: 0px !important}
.x-grid3-td-4{padding-left: 0px !important;padding-right: 0px !important}
.x-grid3-col-0{white-space: normal; word-wrap:break-word;}
.x-grid3-col-1{white-space: normal; word-wrap:break-word;}
.x-grid3-col-2{white-space: normal; word-wrap:break-word;}
.x-grid3-col-3{white-space: normal; word-wrap:break-word;}
.x-grid3-col-4{white-space: normal; word-wrap:break-word;}
.x-form-field-ace{overflow:hidden}

input {	width:expression(this.type=="text" ? "83%" : "style"); }
</style>
<script type="text/javascript" src="/xwiki/yui/yahoo/yahoo-min.js" ></script>
<script type="text/javascript" src="/xwiki/yui/treeview/treeview-min.js" ></script>
<script type="text/javascript" src="/xwiki/yui/treeview/checknode.js"></script>
<script> 
// ----------------------------------- override YUI checknode method -------------------
/**
 * jsj add
 *Invoked when the user press space key
 */
YAHOO.widget.CheckNode.prototype.getKeyCheck = function() {
    return " if( 32 == (window.event ? event.keyCode : event.which) ){ "+"YAHOO.widget.TreeView.getNode(\'" + this.tree.id + "\'," +
        this.index + ").checkClick();"+"if (event.preventDefault) event.preventDefault( ); else event.returnValue = false;}";
};

// Overrides YAHOO.widget.TextNode
YAHOO.widget.CheckNode.prototype.getNodeHtml = function() {
    // this.logger.log("Generating html");
    var sb = new Array();

    sb[sb.length] = '<table border="0" cellpadding="0" cellspacing="0">';
    sb[sb.length] = '<tr>';

    for (i=0;i<this.depth;++i) {
        sb[sb.length] = '<td class="' + this.getDepthStyle(i) + '">&#160;</td>';
    }

    sb[sb.length] = '<td';
    sb[sb.length] = ' id="' + this.getToggleElId() + '"';
    sb[sb.length] = ' class="' + this.getStyle() + '"';
    if (this.hasChildren(true)) {
        sb[sb.length] = ' onmouseover="this.className=';
        sb[sb.length] = 'YAHOO.widget.TreeView.getNode(\'';
        sb[sb.length] = this.tree.id + '\',' + this.index +  ').getHoverStyle()"';
        sb[sb.length] = ' onmouseout="this.className=';
        sb[sb.length] = 'YAHOO.widget.TreeView.getNode(\'';
        sb[sb.length] = this.tree.id + '\',' + this.index +  ').getStyle()"';
    }
    sb[sb.length] = ' onclick="javascript:' + this.getToggleLink() + '">&#160;';
    sb[sb.length] = '</td>';

    // check box
    sb[sb.length] = '<td';
    sb[sb.length] = ' id="' + this.getCheckElId() + '"';
    sb[sb.length] = ' class="' + this.getCheckStyle() + '"';
    sb[sb.length] = ' onclick="javascript:' + this.getCheckLink() + '">';
    sb[sb.length] = '&#160;</td>';


    sb[sb.length] = '<td>';
    sb[sb.length] = '<a';
    sb[sb.length] = ' id="' + this.labelElId + '"';
    sb[sb.length] = ' class="' + this.labelStyle + '"';
    sb[sb.length] = ' href="' + this.href + '"';
    sb[sb.length] = ' target="' + this.target + '"';
    if (this.hasChildren(true)) {
        sb[sb.length] = ' onmouseover="document.getElementById(\'';
        sb[sb.length] = this.getToggleElId() + '\').className=';
        sb[sb.length] = 'YAHOO.widget.TreeView.getNode(\'';
        sb[sb.length] = this.tree.id + '\',' + this.index +  ').getHoverStyle()"';
        sb[sb.length] = ' onmouseout="document.getElementById(\'';
        sb[sb.length] = this.getToggleElId() + '\').className=';
        sb[sb.length] = 'YAHOO.widget.TreeView.getNode(\'';
        sb[sb.length] = this.tree.id + '\',' + this.index +  ').getStyle()"';
    }
    sb[sb.length] = ' onkeypress="javascript:' + this.getKeyCheck(this.event)+'">';
    //sb[sb.length] = '>';
    sb[sb.length] = this.label;
    sb[sb.length] = '</a>';
    sb[sb.length] = '</td>';
    sb[sb.length] = '</tr>';
    sb[sb.length] = '</table>';

    return sb.join("");
};

var grid;                      // table
var isJumpToNext, isJumpToPre; // jump flag for table
var clickTabToNextNum=0, clickTabToPreNum=0, clickTabInGridToNextNum=0, clickTabInGridToPreNum=0; 
// ------------------------------------ extend extjs ------------------------------------
Ext.apply(Ext.grid.GridView.prototype,{
	// remove red triangles
	doRender : function(cs, rs, ds, startRow, colCount, stripe){

		var ts = this.templates, ct = ts.cell, rt = ts.row, last = colCount-1;
		var tstyle = 'width:'+this.getTotalWidth()+';';
		var buf = [], cb, c, p = {}, rp = {tstyle: tstyle}, r;
		for(var j = 0, len = rs.length; j < len; j++){
			r = rs[j]; cb = [];
			var rowIndex = (j+startRow);
			for(var i = 0; i < colCount; i++){
				c = cs[i];
				p.id = c.id;
				p.css = i == 0 ? 'x-grid3-cell-first ' : (i == last ? 'x-grid3-cell-last ' : '');
				p.attr = p.cellAttr = "";
				p.value = c.renderer(r.data[c.name], p, r, rowIndex, i, ds);
				p.style = c.style;
				if(p.value == undefined || p.value === "") p.value = "&#160;";
				cb[cb.length] = ct.apply(p);
			}
			var alt = [];
			if(stripe && ((rowIndex+1) % 2 == 0)){
				alt[0] = "x-grid3-row-alt";
			}
			if(r.dirty){
				alt[1] = " x-grid3-dirty-row";
			}
			rp.cols = colCount;
			if(this.getRowClass){
				alt[2] = this.getRowClass(r, rowIndex, rp, ds);
			}
			rp.alt = alt.join(" ");
			rp.cells = cb.join("");
			buf[buf.length] =  rt.apply(rp);
		}
		return buf.join("");
	},
	
	focusCell : function(row, col, hscroll){
		row = Math.min(row, Math.max(0, this.getRows().length-1));
		var xy = this.ensureVisible(row, col, hscroll);
		this.focusEl.setXY(xy||this.scroller.getXY());
		
		if(Ext.isGecko){
		   // this.focusEl.focus();
		}else{
		   // this.focusEl.focus.defer(1, this.focusEl);
		}
	},

	// private
	layout : function(){
		if(!this.mainBody){
			return; // not rendered
		}
		var g = this.grid;
		var c = g.getGridEl();
		var csize = c.getSize(true);
		var vw = csize.width;

		if(vw < 20 || csize.height < 20){ // display: none?
			return;
		}

		if(g.autoHeight){
			this.scroller.dom.style.overflow = 'hidden';
		}else{
			this.el.setSize(csize.width, csize.height);

			var hdHeight = this.mainHd.getHeight();
			var vh = csize.height - (hdHeight);

			this.scroller.setSize(vw, vh);
			if(this.innerHd){
				this.innerHd.style.width = (vw)+'px';
			}
		}
		if(this.forceFit){
			if(this.lastViewWidth != vw){
				this.fitColumns(false, false);

				this.lastViewWidth = vw;
			}
		}else {
			this.autoExpand();
			this.syncHeaderScroll();
		}
		this.onLayout(vw, vh);
	}
});
Ext.apply(Ext.grid.EditorGridPanel.prototype,{
	// multi-lines wrapper and clear default value
	preEditValue : function(r, field){
		var value = r.data[field];
		if(!r.dirty||(r.dirty && typeof r.modified[field] == 'undefined')){
			value='';
		}else if(typeof value == 'string'){
			value=value.replace(/<br\/>/gi,'\r\n');
			value=this.autoEncode ? Ext.util.Format.htmlDecode(value) : value;
		}
		return value;
	},
	postEditValue : function(value, originalValue, r, field){
		if(typeof value == 'string'){
			value=this.autoEncode ? Ext.util.Format.htmlEncode(value) : value;
			value=value.replace(/\r\n/gi,"<br/>").replace(/\n/gi,'<br/>');
		}
		delete Ext.currentCellNode;
		return value;
	}
});
Ext.apply(Ext.grid.GridEditor.prototype, {
	// set auto size
	autoSize: true,
	doAutoSize : function(){
		if(this.autoSize){
			var parentNode=this.boundEl.dom.parentNode;
			var width=parentNode.clientWidth;
			var height=parentNode.clientHeight;
			switch(this.autoSize){
				case "width":
					this.setSize(width,  "");
				break;
				case "height":
					this.setSize("",  height-1);
				break;
				default:
					this.setSize(width,  height-1);
			}
			Ext.currentCellNode=parentNode;
		}
	}
});
Ext.apply(Ext.form.TextArea.prototype, {
	// auto size cell
	onKeyUpBuffered : function(e){
		if(!e.isNavKeyPress()||e.getKey()==e.ENTER){
			this.autoSize();
		} else if (e.isNavKeyPress()) {		
			if (isJumpToNext) {
				clickTabToNextNum = clickTabToNextNum + 1;
				if (clickTabToNextNum == 2) {
					isJumpToNext = false;
					clickTabToNextNum = 0;
					document.getElementById("addRowBtn").focus();
				}
			} else if (isJumpToPre) {
				clickTabToPreNum = clickTabToPreNum + 1;
				if (clickTabToPreNum == 2) {
					isJumpToPre = false;

					clickTabToPreNum = 0;
					tinyMCE.execCommand('mceFocus',false,'mce_editor_2');
				}
			}
		} 
	},
	autoSize : function(){
		if(!this.grow || !this.textSizeEl){
			return;
		}
		var el = this.el;
		var v = el.dom.value;
		var ts = this.textSizeEl;
		ts.innerHTML = '';
		ts.appendChild(document.createTextNode(v));
		v = ts.innerHTML;
		Ext.fly(ts).setWidth(this.el.getWidth());
		if(v.length < 1){
			v = "&#160;&#160;";
		}else{
			if(Ext.isIE){
				v = v.replace(/\n/g, '<p>&#160;</p>');
			}
			v += this.growAppend;
		}
		ts.innerHTML = v;
		var h = Math.min(this.growMax, Math.max(ts.offsetHeight, this.growMin)+this.growPad);
		if(h != this.lastHeight){
			if(Ext.currentCellNode){
				if(h>Ext.currentCellNode.clientHeight){
					this.lastHeight = h;
					this.el.setHeight(h);
					this.fireEvent("autosize", this, h);
					if(Ext.isIE){
						Ext.currentCellNode.style.height=h;
					}else{
						Ext.currentCellNode.setStyle('height:'+h+'px');

					}
				}
			}else{
				this.lastHeight = h;
				this.el.setHeight(h);
				this.fireEvent("autosize", this, h);
			}
		}
	}
});

// ------------------------------------ wzToolTip tt_Init ------------------------------------
function tt_Init2(){
	if(!(tt_op || tt_n4 || tt_n6 || tt_ie || tt_w3c)) return;
	var htm = tt_n4? '<div style="position:absolute;"></div>' : '', tags, t_tj, over, esc = 'return escape(';
	var i = tt_tags.length;
	while(i--){
		tags = tt_ie? (document.all.tags(tt_tags[i]) || 1)
			: document.getElementsByTagName? (document.getElementsByTagName(tt_tags[i]) || 1)
			: (!tt_n4 && tt_tags[i]=="a")? document.links
			: 1;
		if(tt_n4 && (tt_tags[i] == "a" || tt_tags[i] == "layer")) tags = tt_N4Tags(tt_tags[i]);
		var j = tags.length;
		while(j--){
			if(typeof (t_tj = tags[j]).onmouseover == "function" && t_tj.onmouseover.toString().indexOf(esc) != -1 && !tt_n6 || tt_n6 && (over = t_tj.getAttribute("onmouseover")) && over.indexOf(esc) != -1){
				if(over) t_tj.onmouseover = new Function(over);
				var txt = unescape(t_tj.onmouseover());
				htm += tt_Htm(
					t_tj,
					"tOoLtIp"+i+""+j,
					txt.wzReplace("& ","&")
				);
				t_tj.onmouseover = new Function('e',
					'tt_Show(e,'+
					'"tOoLtIp' +i+''+j+ '",'+
					((typeof t_tj.T_ABOVE != tt_u)? t_tj.T_ABOVE : ttAbove)+','+
					((typeof t_tj.T_DELAY != tt_u)? t_tj.T_DELAY : ttDelay)+','+
					((typeof t_tj.T_FIX != tt_u)? '"'+t_tj.T_FIX+'"' : '""')+','+
					((typeof t_tj.T_LEFT != tt_u)? t_tj.T_LEFT : ttLeft)+','+
					((typeof t_tj.T_OFFSETX != tt_u)? t_tj.T_OFFSETX : ttOffsetX)+','+
					((typeof t_tj.T_OFFSETY != tt_u)? t_tj.T_OFFSETY : ttOffsetY)+','+
					((typeof t_tj.T_STATIC != tt_u)? t_tj.T_STATIC : ttStatic)+','+
					((typeof t_tj.T_STICKY != tt_u)? t_tj.T_STICKY : ttSticky)+','+
					((typeof t_tj.T_TEMP != tt_u)? t_tj.T_TEMP : ttTemp)+
					');'
				);
				t_tj.onmouseout = tt_Hide;
				if(t_tj.alt) t_tj.alt = "";
				if(t_tj.title) t_tj.title = "";
			}
		}
	}
	Element.insert("tooltip_div",{bottom:htm});
	if(document.getElementById) tt_ifrm = document.getElementById("TTiEiFrM");
}

// ------------------------------------ edit grid definition ------------------------------------

var data01 = "$msg.get('wq.evaluation.row2.col2_sample')";
var data02 = "$msg.get('wq.evaluation.row2.col3_sample')";
var data03 = "$msg.get('wq.evaluation.row2.col4_sample')";
var data04 = "$msg.get('wq.evaluation.row2.col5_sample')";

var data00 = "$msg.get('wq.evaluation.row2.col1_sample')";
var data10 = "$msg.get('wq.evaluation.row3.col1_sample')";
var data20 = "$msg.get('wq.evaluation.row4.col1_sample')";
var data30 = "$msg.get('wq.evaluation.row5.col1_sample')";

var data=[
    {id:1,col1:data00,Beginning:data01,Developing:data02,Accomplished:data03,Exemplary:data04},
    {id:1,col1:data10,Beginning:"",Developing:"",Accomplished:"",Exemplary:""},
    {id:1,col1:data20,Beginning:"",Developing:"",Accomplished:"",Exemplary:""},
    {id:1,col1:data30,Beginning:"",Developing:"",Accomplished:"",Exemplary:""}
];

var store=new Ext.data.JsonStore({
    data:data,
    fields:["id","col1","Beginning","Developing","Accomplished","Exemplary"]
    }); 
#set($info_img = '/xwiki/skins/curriki8/icons/exclamation.png')
##var tooltip1="<img class=\"tooltip\" alt=\"\" src=\"/xwiki/skins/curriki8/icons/exclamation.png\" ext:qtip=\"$msg.get("ace.lesson.plan.procedures.time.tooltip")\"/>";
##var tooltip2="<img class=\"tooltip\" alt=\"\" src=\"/xwiki/skins/curriki8/icons/exclamation.png\" ext:qtip=\"$msg.get("ace.lesson.plan.procedures.learningtask.tooltip")\"/>";
##var tooltip3="<img class=\"tooltip\" alt=\"\" src=\"/xwiki/skins/curriki8/icons/exclamation.png\" ext:qtip=\"$msg.get("ace.lesson.plan.procedures.methods.tooltip")\"/>";

var colM = new Ext.grid.ColumnModel([
		{id:"0",header:" ",dataIndex:"col1",sortable:false,fixed:true,width:120,menuDisabled:true,editor:new Ext.form.TextArea({grow:true,fieldClass:'x-form-field-ace'})},
		{id:"1",header:"Beginning",dataIndex:"Beginning",sortable:false,fixed:true,width:110,menuDisabled:true,editor:new Ext.form.TextArea({grow:true,fieldClass:'x-form-field-ace'})},
		{id:"2",header:"Developing",dataIndex:"Developing",sortable:false,fixed:true,width:120,menuDisabled:true,editor:new Ext.form.TextArea({grow:true,fieldClass:'x-form-field-ace'})},
		{id:"3",header:"Accomplished",dataIndex:"Accomplished",sortable:false,fixed:true,width:120,menuDisabled:true,editor:new Ext.form.TextArea({grow:true,fieldClass:'x-form-field-ace'})},
		{id:"4",header:"Exemplary",dataIndex:"Exemplary",sortable:false,fixed:true,menuDisabled:true,editor:new Ext.form.TextArea({grow:true,fieldClass:'x-form-field-ace'})}
	]);

function fn() { 
	grid = new Ext.grid.EditorGridPanel({
	renderTo:"evaluation_div",
	title:"",
	height:200,
	width:570, 
	cm:colM,
	store:store,
	autoExpandColumn:4,
	clicksToEdit:1,
	autoHeight:true,
	autoEncode:true,
	cls :' x-form-field-ace;',
	viewConfig: {scrollOffset: 2},
	fitContainer: true
	});

	grid.on("cellclick", this.cellClick);
	grid.on("afteredit",this.afterEdit,this);
	grid.addListener("keyDown", function(e){
		if (e.isNavKeyPress()) {		
			if (isJumpToNext) {
				clickTabInGridToNextNum = clickTabInGridToNextNum + 1;
				if (clickTabInGridToNextNum == 2) {
				    isJumpToNext = false;
					clickTabInGridToNextNum = 0;
					document.getElementById("addRowBtn").focus();
				}
			} else if (isJumpToPre) {
				clickTabInGridToPreNum = clickTabInGridToPreNum + 1;
				if (clickTabInGridToPreNum == 2) {
					isJumpToPre = false;
					clickTabInGridToPreNum = 0;
					tinyMCE.execCommand('mceFocus',false,'mce_editor_2');
				}
			}
		} 
	});

	grid.getSelectionModel().on("cellselect", function(sel, row, col) {
		curRow = row;curCol = col;
		if (row !=0 && col !=0 && row == grid.getStore().getCount()-1 && col == grid.getColumnModel().getColumnCount()-1) {
			isJumpToNext = true;
		} else {
			isJumpToNext = false;
		}
		if (row == 0 && col == 0) {
			isJumpToPre = true;
		} else {
			isJumpToPre = false;
		}
	});
	//tt_Init2();
}

Ext.onReady(fn); 

function cellClick(obj, row, col, e){

	var record = obj.store.getAt(row);
	if(row == 0 && col == 0){
		if(record.get("col1") == data00)
			record.set("col1", "");
	}else if(row == 1 && col == 0){
		if(record.get("col1") == data10)
			record.set("col1", "");
	}else if(row == 2 && col == 0){
		if(record.get("col1") == data20)
			record.set("col1", "");
	}else if(row == 3 && col == 0){
		if(record.get("col1") == data30)
			record.set("col1", "");
	}else if(row == 0 && col == 1){
		if(record.get("Beginning") == data01)
			record.set("Beginning", "");
	}else if(row == 0 && col == 2){
		if(record.get("Developing") == data02)
			record.set("Developing", "");
	}else if(row == 0 && col == 3){
		if(record.get("Accomplished") == data03)
			record.set("Accomplished", "");
	}else if(row == 0 && col == 4){
		if(record.get("Exemplary") == data04)
			record.set("Exemplary", "");
	}
	//store.commitChanges(); 
}

function afterEdit(obj, row, col, e){
	var r=obj.record;
	var id=r.get("id");
	var name=r.get("name");
	//store.commitChanges(); 
	//Ext.MessageBox.alert("alertdiv","Hello,easyjf open source"); 
}

// insert new row
function addrow(){
	data=[{id:1,col1:'',Beginning:'',Developing:'',Accomplished:'',Exemplary:''}];
	store.loadData(data, true);
	return false;
}

function chekcTableText(){
	
	var arr = store.data;
	for(i=0;i<arr.length;i++){
		var record = store.getAt(i);
		if(record.get("col1") != "" || record.get("Beginning") != "" || record.get("Developing") != "" 
			|| record.get("Accomplished") != "" || record.get("Exemplary") != ""){
			return true;
		}
	}
	return false;
}	

function formatTableString(str){
	str = str.replace(/<br\/>/gi,'\r\n');
	str = Ext.util.Format.htmlDecode(str);
	str = formatString(str, /#/g, "&#35;");
	str = formatString(str, /1/g, "&#49;");
	str = formatString(str, /\*/g, "&#42;");
	str = formatString(str, /a/g, "&#97;");
	str = formatString(str, /A/g, "&#65;");
	str = formatString(str, /i/g, "&#105;");
	str = formatString(str, /I/g, "&#73;");
	str = formatString(str, /g/g, "&#103;");
	str = formatString(str, /h/g, "&#104;");
	str = formatString(str, /k/g, "&#107;");
	str = formatString(str, /_/g, "&#95;");
	str = formatString(str, /~/g, "&#126;");
	str = formatString(str, /-/g, "&#45;");
	str = formatString(str, /{/g, "&#123;");
	str = formatString(str, /}/g, "&#125;");
	str = formatString(str, /\(/g, "&#40;");
	str = formatString(str, /\)/g, "&#41;");
	str = formatString(str, /\|/g, "&#124;");
	str = formatString(str, /\$/g, "&#36;");
	str = formatString(str, /@/g, "&#64;");
	str = formatString(str, /\[/g, "&#91;");
	str = formatString(str, /\]/g, "&#93;");
	str = formatString(str, /</g, "&#60;");
	str = formatString(str, />/g, "&#62;");
	str = str.replace(/\r\n/gi,"\\\\")
	return str;
}
function formatString(str, reg, repls){
	return str.replace(reg, repls)
}	

function getTableText(){
	var str = '\{table\}';
	str += '&#160; | Beginning | Developing | Accomplished | Exemplary\r\n';

	var arr = store.data;
	for(i=0;i<arr.length;i++){
		var record = store.getAt(i);
		var col1 = record.get("col1");
		var beginning = record.get("Beginning");
		var developing = record.get("Developing");
		var accomplished = record.get("Accomplished");
		var exemplary = record.get("Exemplary");

		//if(col1 != "" || beginning != "" || developing != "" || accomplished!="" || exemplary!=""){
			col1 = formatTableString(col1);
			col1 = (col1 == "" ? "&#160;" : col1);
			beginning = formatTableString(beginning);
			beginning = (beginning == "" ? "&#160;" : beginning);
			developing = formatTableString(developing);
			developing = (developing == "" ? "&#160;" : developing);
			accomplished = formatTableString(accomplished);
			accomplished = (accomplished == "" ? "&#160;" : accomplished);
			exemplary = formatTableString(exemplary);
			exemplary = (exemplary == "" ? "&#160;" : exemplary);
			str += col1 + ' | ' + beginning + ' | ' + developing + ' | ' + accomplished + ' | ' + exemplary + ' \r\n';
		//}
	}









	str += '\{table\}';

	return str;
}
</script>
{/pre}

####################################	JS end , title
#set( $noDialogs = $request.getParameter("noDialogs") )  ## ?noDialogs=1 turns off add-path dialogs, for testing, or to enable "edit-again"
  <div class="header">
  #curriki_formtitle($msg.get("wq.plan.title"))
  <br />$msg.get("form.required.fields.instruction")
  </div>
  <form action="" class="curriki-form1" id="inline" method="post">
	  <input type="hidden" name="xredirect" value="$xwiki.getFormEncoded($xwiki.getRequestURL())" />
	  ##sign validation result, default is validate not passed
	  <input type="hidden"  name="CurrikiCode.TextAssetClass_0_text" id="CurrikiCode.TextAssetClass_0_text" value="$msg.get('form.done.wysiwyg.error.wikitext')" />
	  <input type="hidden"  name="CurrikiCode.TextAssetClass_0_type" id="CurrikiCode.TextAssetClass_0_type" value="0" />
	  <input type="hidden"  name="CurrikiCode.AssetClass_0_instructional_component2" id="CurrikiCode.AssetClass_0_instructional_component2" value="curriculum_lp" />
	  <input type="hidden"  name="CurrikiCode.AssetClass_0_hidden_from_search" id="CurrikiCode.AssetClass_0_hidden_from_search" value="0" /> 
	  <input type="hidden"  name="CurrikiCode.AssetClass_0_category" id="CurrikiCode.AssetClass_0_category" value="text" /> 
	  ## successMessage is null, validation not passed
	  <input type="hidden" 	name="successMessage" id="successMessage" value=""      />
	  <input type="hidden" 	name="page"		value="$!request.page"		/>
	  <input type="hidden"	name="pageName"		value="$!newAsset.fullName"	/>
	  <input type="hidden"	name="publishSpace"	value="$!publishSpace"		/>
	  <input type="hidden"	name="parentPage"	value="$!parentPage"		/>
	  #if( "$!noDialogs"!="" )
		<input type="hidden"	name="noDialogs"	value="$noDialogs"		/>
	  #else                                   
		<input type="hidden"	name="flow"		value="$!flow"			/>
		<input type="hidden"	name="createLessonURL"		value="$msg.get('wq.url')"	/> ## for ICT
		<input type="hidden"	name="cameFrom"  #if( "$!cameFrom"=="" ) value="$msg.get('wq.url')"  #else   value="$!cameFrom"   #end />
	  #end             
####################################	step1 
  #curriki_formpart_begin($msg.get("wq.step1.header"))
  #curriki_forminstructions($msg.get("wq.step1.instruction"))
  #curriki_formprompt($msg.get("wq.info.title_title"), $msg.get("wq.info.title_tooltip"), $msg.get("wq.info.title_txt"), true, "medium")
  ##$newAsset.display("title","edit")
  <input type="text" id="CurrikiCode.AssetClass_0_title" name="CurrikiCode.AssetClass_0_title" />
  #curriki_formprompt($msg.get("wq.info.description_title"), $msg.get("wq.info.description_tooltip"), $msg.get("wq.info.description_txt"), true, "medium")
  $newAsset.display("description","edit")
  <table class="subject-educational"><tbody><tr><td>
  #curriki_formprompt($msg.get("sri.fw_items_title"), $msg.get("sri.fw_items_tooltip"), $msg.get("sri.fw_items_txt"), true, "")
#skbListHereEditable( "CurrikiCode.AssetClass_0_trainedTopicsAndCompetencies" "trainedTopicsAndCompetencies" "topic, competency" "$!asset.trainedTopicsAndCompetencies")
##  $newAsset.display("fw_items","edit")
  </td><td>
  #curriki_formprompt($msg.get("sri.educational_level_title"), $msg.get("sri.educational_level_tooltip"), $msg.get("sri.educational_level_txt"), true, "medium")
#skbListHereEditable( "CurrikiCode.AssetClass_0_eduLevelFine" "eduLevelFine" "level" "$!asset.eduLevelFine")
##  $newAsset.display("educational_level","edit")
  </td></tr></tbody></table> ##class="subject-educational"
  #curriki_formprompt($msg.get("sri.keywords_title"), $msg.get("sri.keywords_tooltip"), $msg.get("sri.keywords_txt"), false, "medium")
  $newAsset.display("keywords","edit")
  #curriki_formprompt($msg.get("sri.language_title"), $msg.get("sri.language_tooltip"), $msg.get("sri.language_txt"), false, "medium")
  <select name="CurrikiCode.AssetClass_0_language" size="1" style="position:absolute; left:8; top:8; width:88; height:22; display:block;" onchange="EintragPruefen('ComboBox', 'Edit')">
    <option value='${con.getLanguageId($lang,true)}'>$con.getLanguageName($lang,$lang)</option>
    #set($supportedLanguages2 = $xwiki.getXWikiPreference("languages").replaceAll(","," "))
    #foreach($lang2 in $supportedLanguages2.split(" "))##
	  #if($lang!=$lang2)
		  <option value='${con.getLanguageId($lang2,true)}'>$con.getLanguageName($lang2,$lang2)</option>
	  #end
	  #end
</select>
  ##$newAsset.display("language","edit")
  #curriki_formpart_end() 
####################################	step2
  #curriki_formpart_begin($msg.get("wq.step2.header")) ## {
  #curriki_forminstructions($msg.get("wq.step2.instruction"))

  ##Introduction:
  #curriki_formprompt($msg.get("wq.intro.title"), $msg.get("wq.intro.tooltip"), $msg.get("wq.intro.instruction"), true, "medium")
  <textarea id="nlp_intro" name="nlp_intro"></textarea>  ## in JS, this is replaced w/ WYSIWYG

  ##The Task:
  #curriki_formprompt($msg.get("wq.task.title"), $msg.get("wq.task.tooltip"), $msg.get("wq.task.instruction"), true, "medium")
  <textarea id="nlp_task" name="nlp_task"></textarea>  ## in JS, this is replaced w/ WYSIWYG

  ##The Process:
  #curriki_formprompt($msg.get("wq.process.title"), $msg.get("wq.process.tooltip"), $msg.get("wq.process.instruction"), true, "medium")
  <textarea id="nlp_process" name="nlp_process"></textarea>  ## in JS, this is replaced w/ WYSIWYG

  ##Evaluation:
  #curriki_formprompt($msg.get("wq.eval.title"), $msg.get("wq.eval.tooltip"), $msg.get("wq.eval.instruction"), true, "medium")
  <div id="evaluation_div"> </div>  <button class="button button-orange" id="addRowBtn" onclick="return addrow();">$msg.get("ace.lesson.plan.procedures.addrow")</button>

  ##Conclusion:
  #curriki_formprompt($msg.get("wq.conclusion.title"), $msg.get("wq.conclusion.tooltip"), $msg.get("wq.conclusion.instruction"), true, "medium")
  <textarea id="nlp_conclusion" name="nlp_conclusion"></textarea>  ## in JS, this is replaced w/ WYSIWYG

  ##Credits & References:
  #curriki_formprompt($msg.get("wq.cred.title"), $msg.get("wq.cred.tooltip"), $msg.get("wq.cred.instruction"), false, "medium")
  <textarea id="nlp_cred" name="nlp_cred"></textarea>  ## in JS, this is replaced w/ WYSIWYG

  ##Standards:
  #curriki_formprompt($msg.get("wq.standards.title"), $msg.get("wq.standards.tooltip"), $msg.get("wq.standards.instruction"), false, "medium")
  <textarea id="nlp_standards" name="nlp_standards"></textarea>  ## in JS, this is replaced w/ WYSIWYG

  ## Required Resources (attachments) -- fileselection w/ buttons
  #curriki_formprompt($msg.get("wq.required.attachments.title"), $msg.get("wq.required.attachments.tooltip"), $msg.get("wq.required.attachments.instruction"), false, "")
<iframe src="$newAsset.getURL("view", "xpage=lpattachments")"
		onload="try { setAttachmentsIframeSize(); } catch(e) { alert('iframe onload error: '+e+' ...'); return false; }"
		id="attachment_iframe" name="attachment_iframe" width="100%" scrolling="auto" marginheight="0" marginwidth="0"	frameborder="0" >
  <h2>Sorry, your browser doesn't support iframes. Attachment Uploading functionality disabled.</h2> 
</iframe>
  #curriki_formpart_end() ## }
####################################	step3
  #curriki_formpart_begin($msg.get("form.scratch.step3.header")) 
  #curriki_forminstructions($msg.get("form.scratch.step3.instruction"))
  #curriki_formprompt($msg.get("sri.right_holder_title"), $msg.get("sri.right_holder_tooltip"), $msg.get("sri.right_holder_txt"), true, "medium")
  $newAsset.display("rightsHolder","edit")
  #curriki_formprompt($msg.get("sri.rights_title"), $msg.get("sri.rights_tooltip"), $msg.get("sri.rights_txt"), false, "medium")
  $newAsset.display("rights", "edit")
  #curriki_formprompt($msg.get("sri.license_type_title"), $msg.get("sri.license_type_tooltip"), $msg.get("sri.license_type_txt"), false, "medium")
  <p><label>$msg.get("sri.license_type_heading")</label></p>		
  $newAsset.display("licenseType","edit")
  #curriki_formpart_end() 
####################################	step4
  #curriki_formpart_begin($msg.get("form.scratch.step4.header")) 
  <p><label>$msg.get("form.scratch.step4.instruction")</label></p>
  <p class="links">
	 <button
	  onclick="try { if (document.forms.inline.onsubmit) document.forms.inline.onsubmit(); if (checkWebQuestForm()) { clearUnloadDialog(); startWaitingDialog(); document.forms.inline.action='$msg.get("form.done.url")'; document.forms.inline.submit(); } return false; } catch(e) { alert('$msg.get("form.scratch.submit.button") button onclick error: '+e+' ...'); return false; }"
	  >$msg.get("form.scratch.submit.button")</button>
	 #if( "$!cameFrom" != "" ) 
	   #set( $cancelURL = $cameFrom )
	 #else 
	   #set( $cancelURL = $xwiki.getURL("Main.WebHome") ) ## cameFrom not set means go to WebHome
	 #end 
	 <button class="cancel"
	  onclick="try { clearUnloadDialog(); window.location.href='$cancelURL'; return false; } catch(e) { alert('$msg.get("form.scratch.cancel.button") button onclick error: '+e+' ...'); return false; }"
	  >$msg.get("form.scratch.cancel.button")</button>
  </p>
  #curriki_formpart_end() 
#####################################################################
<div class="tooltips">
    {pre} $xwiki.addTooltipJS() {/pre}
</div>
</form>
#set( $noWYSIWYG  = $request.getParameter("noWYSIWYG") ) ##For testing,etc, add parameter ?noWYSIWYG=1 to force WYSIWYG editors to not display, and use TEXTAREA instead
#if( "$!noWYSIWYG" == "" ) ## {
#curriki_wysiwyg_loader_preamble()
#if( "$!publishSpace"=="" )            ## {
 #set( $user = $context.user )
  #if( $user.startsWith("XWiki.") )    ## {
    #set( $shortname = $user.substring(6) )
  #else                                ## } {
    #set( $shortname = $user )
  #end                                 ## }
  #set( $wysi_publishSpace = "Coll_${shortname}" )
#else ## } {
  #set( $wysi_publishSpace = $publishSpace )
#end                                   ## }
#curriki_SLP_wysiwyg_loader_editor("nlp_intro", $newAsset, $wysi_publishSpace)        ## id="mce_editor_0"
#curriki_SLP_wysiwyg_loader_editor("nlp_task", $newAsset, $wysi_publishSpace)         ## id="mce_editor_1"
#curriki_SLP_wysiwyg_loader_editor("nlp_process", $newAsset, $wysi_publishSpace)      ## id="mce_editor_2"
#curriki_SLP_wysiwyg_loader_editor("nlp_conclusion", $newAsset, $wysi_publishSpace)   ## id="mce_editor_3"
#curriki_SLP_wysiwyg_loader_editor("nlp_cred", $newAsset, $wysi_publishSpace)         ## id="mce_editor_4"
#curriki_SLP_wysiwyg_loader_editor("nlp_standards", $newAsset, $wysi_publishSpace)    ## id="mce_editor_5"
#end ## } -- if "$!noWYSIWYG"==""
{pre}<script language="javascript" type="text/javascript">
/* <![CDATA[ */
/*
 * this javascript code  must be at end, otherwise  strange   things
 * happen, like "License Deed" doesn't show up...
 */
function startWaitingDialog() {
#if( "$!noDialogs"!="1" )  ## {
  Curriki.showLoading();
#end ## }
}
/*
 * on window unload, dialog warning of dataloss
 */
setUnloadDialog();
/*
 * HACK: Tell TinyMCE to leave-alone the URL's ... they are fine as-is.. as relative links
 * during edit in AssetTemp/xxxxxxx, and as permanent links in $wysi_publishSpace on save
 */
tinyMCE.convertURL = function(url, node, on_save) { return url; };
/* ]]> */
</script>{/pre}
#end ## } -- else, aka "$!newAsset"!="" 
#end ## } -- $context.user=="XWiki.XWikiGuest"