(function(){Ext.ns("Curriki.module.flag");Ext.ns("Curriki.data.flag");var C=Curriki.module.flag;var A=Curriki.data.flag;var B=Curriki.ui;C.init=function(){var E="flag.dialog.reason.";A.reasonList=[];var D=1;while(_(E+D)!==E+D){A.reasonList.push([D,_(E+D),D]);++D}A.reasonList.push(["alt",_(E+"alt"),D]);C.reasonStore=new Ext.data.SimpleStore({fields:["id","text","sortValue"],sortInfo:{field:"sortValue",direction:"ASC"},data:A.reasonList,id:0});C.mainDlg=Ext.extend(B.dialog.Actions,{initComponent:function(){Ext.apply(this,{id:"FlagDialogueWindow",title:_("flag.dialog.header"),cls:"flag resource resource-view",autoScroll:false,items:[{xtype:"form",id:"FlagDialoguePanel",formId:"FlagDialogueForm",labelWidth:200,labelAlign:"top",autoScroll:false,border:false,defaults:{labelSeparator:""},monitorValid:true,buttonAlign:"right",buttons:[{text:_("flag.dialog.cancel.btt"),id:"cancelbutton",cls:"button button-cancel",listeners:{click:{fn:function(){Curriki.logView("/features/flag/cancelled");this.close();if(Ext.isIE){window.location.reload()}},scope:this}}},{text:_("flag.dialog.submit.btt"),id:"nextbutton",cls:"button button-confirm",formBind:true,listeners:{click:{fn:function(){console.log("Flaging",A.resourcePage);var H=this;var I=function(J){console.log("Flag callback",J);Curriki.logView("/features/flag/flagged/"+A.resourcePage.replace(".","/"));H.close();C.msgComplete()};var G=Ext.getCmp("flag-reason").getValue();var F=Ext.getCmp("flag-alt-reason")?Ext.getCmp("flag-alt-reason").getValue():"";Curriki.assets.Flag(A.resourcePage,G,F,I)},scope:this}}}],items:[{xtype:"box",autoEl:{tag:"div",html:_("flag.dialog.guidingquestion1.txt"),cls:"guidingquestion"}},{xtype:"box",autoEl:{tag:"div",html:_("flag.dialog.instruction1.txt"),cls:"instruction"}},{xtype:"box",autoEl:{tag:"div",html:_("flag.dialog.guidingquestion2.txt"),cls:"guidingquestion"}},{xtype:"combo",id:"flag-reason",hiddenName:"flagReason",mode:"local",store:C.reasonStore,displayField:"text",valueField:"id",emptyText:_("flag.dialog.reason.unselected"),width:440,selectOnFocus:true,forceSelection:true,triggerAction:"all",allowBlank:false,editable:false,typeAhead:false,hideLabel:false,labelStyle:"instruction",labelClass:"instructionClass",labelCls:"instructionCls",fieldLabel:_("flag.dialog.required.field.icon")+_("flag.dialog.instruction2.txt"),clearCls:"",listeners:{select:{fn:function(J,F,G){var I=F.id;var H=Ext.getCmp("FlagDialoguePanel").getForm().findField("flag-alt-reason");if(I==="alt"){H.show()}else{H.hide()}}},render:{fn:function(F){F.getEl().up(".x-form-item").down("label").addClass("instruction");F.focus()}}}},{xtype:"textarea",id:"flag-alt-reason",hiddenName:"flagAltReason",width:580,minLength:5,maxLength:300,allowBlank:false,hidden:true,hideLabel:false,labelStyle:"instruction",labelClass:"instructionClass",fieldLabel:_("flag.dialog.required.field.icon")+_("flag.dialog.instruction4.txt"),enableKeyEvents:true,listeners:{hide:{fn:function(F){F.disable();F.getEl().up(".x-form-item").setDisplayed(false)}},show:{fn:function(F){F.enable();F.getEl().up(".x-form-item").setDisplayed(true)}},render:{fn:function(F){F.getEl().up(".x-form-item").down("label").addClass("instruction")}},keypress:{fn:function(G,H){if(G.getValue().length>=300){var F=H.getKey();if(!Ext.isIE&&(H.isNavKeyPress()||F==H.BACKSPACE||(F==H.DELETE&&H.button==-1))){return }if(Ext.isIE&&(F==H.BACKSPACE||F==H.DELETE||H.isNavKeyPress()||F==H.HOME||F==H.END)){return }H.preventDefault();H.stopPropagation();H.stopEvent()}}},invalid:{fn:function(F,G){if(F.getValue().length>300){F.setValue(F.getValue().substring(0,300))}}}}},{xtype:"box",autoEl:{tag:"div",html:_("flag.dialog.instruction5.txt"),cls:"instruction"}}]}]});C.mainDlg.superclass.initComponent.call(this)}});Ext.reg("flagDialog",C.mainDlg);C.completeDlg=Ext.extend(B.dialog.Messages,{initComponent:function(){Ext.apply(this,{id:"FlagDialogueWindow",title:_("flag.success.dialog.header"),cls:"flag resource resource-view",autoScroll:false,buttonAlign:"right",buttons:[{text:_("flag.success.dialog.button"),id:"closebutton",cls:"button button-confirm",listeners:{click:{fn:function(){this.close();if(Ext.isIE){window.location.reload()}},scope:this}}}],items:[{xtype:"box",autoEl:{tag:"div",cls:"mgn-top",html:_("flag.success.dialog.message")}}]});C.completeDlg.superclass.initComponent.call(this)}});Ext.reg("flagCompleteDialog",C.completeDlg);C.msgComplete=function(){B.show("flagCompleteDialog")};C.initialized=true;return C.initialized};C.display=function(D){if(!Ext.isEmpty(D)&&(C.init())){A.resourcePage=D.resourcePage||null;if(A.resourcePage){B.show("flagDialog");Curriki.logView("/features/flag/started")}}};C.start=function(D){Ext.onReady(function(){C.display(D)})}})();